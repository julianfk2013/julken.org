<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hyper Clicker — Deluxe</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet" />
  <style>
    /*
      Hyper Clicker — Deluxe
      - Neutral clicker theme (no space references)
      - Goal/progress bar kept removed; small badges instead
      - Tons of effects (ripples, confetti, crit pop, bokeh background, shake, coin drops)
      - Prestige tuned and Overdrive renamed to Frenzy
      - Single-file HTML+CSS+JS
    */

    :root {
  --bg:#0f1221; --bg2:#141a2e; --ink:#f5f8ff; --muted:#a8b2c7;
  --panel:#1a2240; --panel2:#1f2b53; --panel3:#162044;
  --a1:#4fd1c5; --a2:#f59e0b; --a3:#60a5fa; --warn:#f59e0b; --danger:#ef4444; --ok:#34d399;
      --glow: rgba(255,255,255,.1); --shadow: rgba(0,0,0,.45);
    }
    .theme-light{
  --bg:#f7fafc; --bg2:#edf2f7; --ink:#0f172a; --muted:#475569;
  --panel:#ffffff; --panel2:#f1f5f9; --panel3:#e2e8f0;
  --a1:#0ea5e9; --a2:#f59e0b; --a3:#22c55e; --warn:#d97706; --danger:#dc2626; --ok:#16a34a;
      --glow:rgba(0,0,0,.07); --shadow: rgba(0,0,0,.15);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,Helvetica,sans-serif;
      background: radial-gradient(1400px 900px at 20% -10%, var(--bg2), var(--bg));
      color:var(--ink);
      display:grid; grid-template-rows:auto auto 1fr auto; gap:14px; padding:14px; overflow:hidden;
    }

    /* Header */
    header{display:flex;align-items:center;justify-content:space-between;gap:8px;z-index:3}
    .brand{display:flex;align-items:center;gap:10px}
  .logo{width:42px;height:42px;border-radius:12px;background:conic-gradient(from 0deg, var(--a1), var(--a2), var(--a3), var(--a1));box-shadow:0 0 22px rgba(79,209,197,.35)}
  h1{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,Helvetica,sans-serif;font-weight:900;font-size:clamp(18px,4.2vw,34px);letter-spacing:.02em;color:var(--ink)}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .btn{background:linear-gradient(45deg,var(--panel2),var(--panel));color:var(--ink);border:2px solid rgba(230,240,255,.4);border-radius:12px;padding:8px 12px;cursor:pointer;user-select:none;box-shadow:0 8px 20px var(--shadow), inset 0 0 20px var(--glow);transition:transform .15s ease, filter .2s ease}
    .btn:hover{transform:translateY(-1px) scale(1.02)} .btn:active{transform:translateY(1px) scale(.98)}
    .btn[data-ghost]{background:transparent;border-color:rgba(159,180,209,.6);color:var(--muted)} .btn[data-accent]{border-color:var(--a1);color:var(--a1)} .btn[data-danger]{border-color:var(--danger);color:var(--danger)}

    /* Top Stat Strip */
    .stats{display:grid;grid-template-columns:repeat(6,minmax(150px,1fr));gap:10px;z-index:2}
    @media (max-width:1200px){ .stats{grid-template-columns:repeat(3,1fr)} }
    @media (max-width:700px){ .stats{grid-template-columns:repeat(2,1fr)} }
  .stat{background:linear-gradient(45deg,var(--panel2),var(--panel));border:2px solid rgba(230,240,255,.35);border-radius:14px;padding:10px 12px;text-align:center;box-shadow:0 6px 16px var(--shadow), inset 0 0 18px var(--glow)}
  .stat h3{margin:0 0 6px;font-size:12px;color:var(--muted)} .val{font-size:clamp(18px,4vw,28px);font-weight:800} .val.pulse{animation:pulse .28s ease-out}
  @keyframes pulse{0%{transform:scale(1)}40%{transform:scale(1.08)}100%{transform:scale(1)}}

    /* Main Layout: left rail, core center, right rail */
    .shell{display:grid;grid-template-columns:280px 1fr 320px;gap:14px;min-height:0}
    @media (max-width:1300px){ .shell{grid-template-columns:240px 1fr 280px} }
    @media (max-width:1020px){ .shell{grid-template-columns:1fr} }

    .rail{position:relative;background:linear-gradient(45deg,var(--panel2),var(--panel));border:2px solid rgba(230,240,255,.35);border-radius:16px;box-shadow:0 14px 28px var(--shadow), inset 0 0 26px var(--glow);padding:14px;min-height:0;overflow:auto}
    .core{position:relative;background:linear-gradient(45deg,var(--panel2),var(--panel));border:2px solid rgba(230,240,255,.35);border-radius:16px;box-shadow:0 14px 28px var(--shadow), inset 0 0 26px var(--glow);padding:18px;min-height:0;display:grid;grid-template-rows:auto auto 1fr;gap:12px}

    /* Core: Big Button zone */
    .click-wrap{display:grid;place-items:center;gap:8px;margin-top:6px}
  #bigBtn{position:relative;display:inline-grid;place-items:center;font-family:Inter;font-weight:900;letter-spacing:.04em;font-size:clamp(24px,6vw,56px);border:4px solid rgba(230,240,255,.5);border-radius:18px;padding:26px 42px;color:#0f172a;background:linear-gradient(45deg,#f8fafc,#e2e8f0);box-shadow:0 16px 28px var(--shadow),0 0 24px rgba(99,102,241,.25);cursor:pointer;user-select:none;transition:transform .06s ease, filter .2s ease;overflow:hidden}
  #bigBtn:hover{transform:translateY(-1px) scale(1.02); filter:brightness(1.05)} #bigBtn:active{transform:translateY(2px) scale(.98)}
  #bigBtn .ripple{position:absolute;border-radius:50%;background:radial-gradient(circle,#ffffffaa,#ffffff22);transform:translate(-50%,-50%);width:0;height:0;animation:rip .52s ease-out forwards}
    @keyframes rip{from{opacity:.6}to{width:230px;height:230px;opacity:0}}
    #clickFx{position:fixed;inset:0;pointer-events:none;z-index:6}

    /* Removed the old combo progress/goal-like bar; replaced with small badges */
    .meta{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:center}
    .badge{border:1px solid rgba(159,180,209,.6);color:var(--muted);padding:3px 8px;border-radius:999px;font-size:12px;user-select:none}
    .badge[data-qty]{cursor:pointer}
    .badge.active{border-color:var(--a1);color:var(--a1);box-shadow:inset 0 0 14px rgba(71,211,255,.18)}
    .badge.hidden{display:none}

    /* Tabs in left rail */
    .tabs{display:flex;flex-direction:column;gap:8px}
    .tab{padding:10px 12px;border-radius:10px;border:2px solid rgba(230,240,255,.38);cursor:pointer;background:transparent;color:var(--ink);text-align:left}
    .tab.active{background:var(--panel2);box-shadow:inset 0 0 18px var(--glow)}

    /* Shop grid and cards */
    .section{display:none}
    .section.active{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:10px;align-content:start}
    .card{display:grid;gap:6px;background:linear-gradient(45deg,var(--panel3),var(--panel2));color:var(--ink);border:2px solid rgba(230,240,255,.35);border-radius:14px;padding:12px;transition:transform .12s ease}
    .card:hover{transform:translateY(-2px)}
    .card .row{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .card .title{font-weight:800}
    .card .desc{font-size:12px;color:var(--muted)}
    .card .cost{font-size:13px;color:var(--warn)}
    .card .owned{font-size:12px;color:var(--muted)}
    .card.aff{animation:aff 1.2s ease-in-out infinite alternate}
    @keyframes aff{0%{box-shadow:0 0 0 var(--shadow), inset 0 0 12px var(--glow)}100%{box-shadow:0 0 22px rgba(71,211,255,.22), inset 0 0 20px rgba(71,211,255,.2)}}

    /* Right rail panels */
    .panel{background:linear-gradient(45deg,var(--panel),var(--panel2));border:1px solid rgba(230,240,255,.25);border-radius:12px;padding:10px;margin-bottom:10px}
    .panel h3{margin:0 0 8px;color:var(--muted);font-size:13px;letter-spacing:.03em}
    .kv{display:grid;grid-template-columns:1fr auto;gap:6px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}

    /* Effects */
    .flash{animation:flash .5s ease-out}
    @keyframes flash{0%{box-shadow:0 0 0 0 rgba(126,249,255,0), inset 0 0 0 0 rgba(126,249,255,0)}30%{box-shadow:0 0 18px 4px rgba(126,249,255,.5), inset 0 0 12px 2px rgba(126,249,255,.35)}100%{box-shadow:0 0 0 0 rgba(126,249,255,0), inset 0 0 0 0 rgba(126,249,255,0)}}
    .critFx{position:fixed;pointer-events:none;color:#ffd166;font-weight:900;font-size:24px;text-shadow:0 0 12px rgba(255,209,102,.85);z-index:7;animation:crit 900ms ease-out forwards}
    @keyframes crit{0%{transform:translateY(0) scale(1);opacity:1}100%{transform:translateY(-60px) scale(1.2);opacity:0}}
    .confetti{position:fixed;width:8px;height:14px;pointer-events:none;z-index:7;will-change:transform,opacity;animation:conf 900ms ease-out forwards}
    @keyframes conf{0%{transform:translate(0,0) rotate(0);opacity:1}100%{transform:translate(var(--cx,0),var(--cy,80px)) rotate(360deg);opacity:0}}
    @keyframes float{0%{transform:translateY(0);opacity:1}100%{transform:translateY(-40px);opacity:0}}

  /* Extra decorations */
  .btn.ready{border-color:var(--a1);box-shadow:0 0 14px rgba(79,209,197,.35), inset 0 0 18px rgba(79,209,197,.2);animation:ready 1.6s ease-in-out infinite}
  @keyframes ready{0%{filter:brightness(1)}50%{filter:brightness(1.07)}100%{filter:brightness(1)}}
  .coin{position:fixed;width:12px;height:12px;border-radius:50%;background:radial-gradient(circle at 35% 35%,#fff,#f59e0b 40%, #b45309 70%);box-shadow:0 0 10px #f59e0b88;z-index:7;pointer-events:none;animation:coin 900ms ease-out forwards}
  @keyframes coin{0%{transform:translate(0,0) scale(1) rotate(0);opacity:1}100%{transform:translate(var(--cx,0), var(--cy,120px)) scale(.8) rotate(360deg);opacity:0}}
  .trail{position:fixed;width:6px;height:6px;border-radius:50%;background:radial-gradient(circle,#60a5fa,#60a5fa00);pointer-events:none;z-index:6;animation:trail .5s ease-out forwards}
  @keyframes trail{0%{opacity:.8;transform:translate(0,0) scale(1)}100%{opacity:0;transform:translate(0,-12px) scale(.4)}}

  /* Background canvas and overlay (soft bokeh) */
  #bg{position:fixed;inset:0;width:100vw;height:100vh;z-index:0;pointer-events:none;opacity:.8;filter:blur(0.2px)}
    #overlay{position:fixed;inset:0;pointer-events:none;z-index:5}

    footer{text-align:center;color:var(--muted);font-size:12px;z-index:2}

    /* Helper cheatsheet */
    .help{display:grid;grid-template-columns:1fr 1fr;gap:6px}
    .help small{color:var(--muted)}

    /* Cosmetic inventory grid */
    .cos-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:10px}
    .cos{display:grid;gap:6px;padding:8px;border:1px dashed rgba(230,240,255,.3);border-radius:10px}
    .cos .swatch{height:26px;border-radius:8px}
    .cos .apply{font-size:12px}
  </style>
</head>
<body>
  <canvas id="bg" aria-hidden="true"></canvas>
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <h1>Hyper Clicker — Deluxe</h1>
    </div>
    <div class="toolbar">
      <button id="themeBtn" class="btn" data-ghost>Theme</button>
      <button id="sfxBtn" class="btn" data-ghost>SFX: Off</button>
      <button id="vfxBtn" class="btn" data-ghost>VFX: On</button>
      <button id="exportBtn" class="btn">Export</button>
      <button id="importBtn" class="btn">Import</button>
      <button id="resetBtn" class="btn" data-danger>Reset</button>
    </div>
  </header>

  <section class="stats" aria-label="primary stats">
    <div class="stat"><h3>Score</h3><div id="score" class="val">0</div></div>
    <div class="stat"><h3>SPS</h3><div id="sps" class="val">0</div></div>
    <div class="stat"><h3>SPC</h3><div id="spc" class="val">1</div></div>
    <div class="stat"><h3>Combo</h3><div id="comboVal" class="val">x1</div></div>
    <div class="stat"><h3>Ascend Target</h3><div id="ascTarget" class="val">1e6</div></div>
    <div class="stat"><h3>Projected Stars</h3><div id="projStars" class="val">+0</div></div>
  </section>

  <main class="shell">
    <!-- Left Rail: Navigation Tabs -->
    <aside class="rail" id="left-rail">
      <div class="tabs" role="tablist">
  <button class="tab active" data-tab="generators">Generators</button>
  <button class="tab" data-tab="upgrades">Upgrades</button>
  <button class="tab" data-tab="relics">Relics</button>
  <button class="tab" data-tab="events">Events</button>
  <button class="tab" data-tab="cosmetics">Cosmetics</button>
  <button class="tab" data-tab="achv">Achievements</button>
  <button class="tab" data-tab="settings">Settings</button>
      </div>
      <hr style="border-color:var(--glow);opacity:.5;margin:12px 0" />
      <div class="panel">
        <h3>Helper Keys</h3>
        <div class="help">
          <div><strong>Space</strong> Click</div>
          <div><strong>Enter</strong> Buy first affordable</div>
          <div><strong>1..7</strong> Switch tabs</div>
          <div><strong>F</strong> Frenzy</div>
          <div><strong>G</strong> Toggle Grid</div>
          <div><strong>Shift</strong> Hold to rapid-fire</div>
        </div>
      </div>
    </aside>

    <!-- Core Center: Click, badges, and content sections -->
    <section class="core" id="core">
      <div class="click-wrap">
  <div id="bigBtn" role="button" tabindex="0" aria-label="Click or press space to score">CLICK</div>
        <div id="clickFx" aria-hidden="true"></div>
        <div class="meta" style="width:100%;max-width:820px">
          <div class="badge" id="comboBadge">Combo x1</div>
          <div id="critTag" class="badge hidden">CRIT!</div>
          <div class="badge" id="overdriveBadge">Frenzy: Off</div>
          <div class="badge" id="dailyBadge">Daily Mod: None</div>
          <div class="badge" id="gridBadge">Grid: Off</div>
          <div class="badge" aria-label="purchase quantity" id="qtyWrap">
            <span class="badge" data-qty="1">x1</span>
            <span class="badge" data-qty="10">x10</span>
            <span class="badge" data-qty="100">x100</span>
            <span class="badge" data-qty="max">MAX</span>
          </div>
        </div>
      </div>

  <div class="section active" id="generators"></div>
  <div class="section" id="upgrades"></div>
      <div class="section" id="relics"></div>
      <div class="section" id="events"></div>
      <div class="section" id="cosmetics"></div>
      <div class="section" id="achv"></div>
      <div class="section" id="settings"></div>
    </section>

    <!-- Right Rail: Info and Ascend -->
    <aside class="rail" id="right-rail">
      <div class="panel">
        <h3>Records</h3>
        <div class="kv"><span>Total Earned</span><span id="tEarn" class="mono">0</span></div>
        <div class="kv"><span>Total Clicks</span><span id="tClicks" class="mono">0</span></div>
        <div class="kv"><span>Play Time</span><span id="pTime" class="mono">0s</span></div>
      </div>
      <div class="panel">
  <h3>Prestige</h3>
        <div class="kv"><span>Prestige Level</span><span id="prestigeLvl" class="mono">0</span></div>
        <div class="kv"><span>Stars</span><span id="stars" class="mono">0</span></div>
        <div class="kv"><span>Multiplier</span><span id="mult" class="mono">x1.00</span></div>
        <div class="kv"><span>Next Target</span><span id="nextTarget" class="mono">1e6</span></div>
        <div class="kv"><span>Projected Stars</span><span id="nextStars" class="mono">+0</span></div>
        <button id="prestigeBtn" class="btn" data-accent disabled>Ascend</button>
        <small style="color:var(--muted)">Easier early; each Ascend increases the target. Score above target yields more stars.</small>
      </div>
      <div class="panel">
        <h3>Frenzy</h3>
        <p style="margin:0 0 8px;color:var(--muted)">Burst mode: temporary SPC boost and crit chance, then cooldown.</p>
        <div class="kv"><span>Status</span><span id="odStatus" class="mono">Ready</span></div>
        <div class="kv"><span>Cooldown</span><span id="odCd" class="mono">0s</span></div>
        <button id="odBtn" class="btn">Trigger Frenzy (F)</button>
      </div>
    </aside>
  </main>

  <footer>© 2025 Hyper Clicker — Deluxe. Tip: Space to click. 1..7 tabs. F to Frenzy. Enter to buy first affordable. G toggles grid.</footer>
  <div id="overlay" aria-hidden="true"></div>

  <script>
  ;(()=>{
    'use strict'
    /* ===================== Utilities ===================== */
    const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s))
    const now=()=>Date.now()
    const clamp=(v,a,b)=>Math.min(b,Math.max(a,v))
    const rnd=(a,b)=>Math.random()*(b-a)+a

    const fmt=n=>format(n)
    function format(num){
      if(!isFinite(num)) return '∞'
      const suf=['','K','M','B','T','Qa','Qi','Sx','Sp','Oc','No','Dc','Ud','Dd','Td','Qad']
      const neg=num<0; num=Math.abs(num)
      if(num<1000) return (neg?'-':'')+(num%1===0?num.toString():num.toFixed(2))
      const tier=Math.floor(Math.log10(num)/3)
      const scaled=num/Math.pow(10,tier*3)
      return (neg?'-':'')+scaled.toFixed(scaled>=100?0:scaled>=10?1:2)+suf[tier]
    }

    const Storage={
      get(k,f){ try{ const v=localStorage.getItem(k); return v==null?f:v }catch{ return f } },
      set(k,v){ try{ localStorage.setItem(k,v) }catch{} },
      rem(k){ try{ localStorage.removeItem(k) }catch{} }
    }

    /* ===================== Data & Balance ===================== */
    // Version bump for migration
  const VERSION=3

    // Prestige tuning: easier early target, scales up each Ascend
    // threshold(level) = base * scale^level
    // stars gained = floor( max(1, log10( score / threshold + 1 ) * starScale ) )
    // multiplier per star starts modest and ramps slightly with prestige level
  const PRESTIGE_BAL={ base:1e6, scale:4.5, starScale:2.2, perStar:0.10, perLevelRamp:0.005, perStarCap:0.25 }

    const DEF={ v:VERSION,
      score:0, sps:0, spc:1,
      totalEarned:0, totalClicks:0, playMs:0, last:now(),
  qty:'1', theme:'dark', sfx:false, vfx:true,
      // prestige state
  prestige:{ lvl:0, stars:0, mult:1, base:PRESTIGE_BAL.base, scale:PRESTIGE_BAL.scale },
      // ownerships
  owned:{ generators:{}, upgrades:{} },
      // collections
      ach:{}, arts:{}, quests:{}, relics:{}, cosmetics:{},
      // systems
      overdrive:{ readyAt:0, activeUntil:0, cooldown:20000, duration:7000 },
      grid:false,
      dailySeed:0,
    }

    const GENERATORS=[
      {id:'clickbot',name:'Click Bot',base:100,gain:1,desc:'+1 SPS each',scale:1.15},
      {id:'macro',name:'Macro Runner',base:600,gain:5,desc:'+5 SPS each',scale:1.15},
      {id:'farm',name:'Idle Farm',base:3600,gain:30,desc:'+30 SPS each',scale:1.16},
      {id:'factory',name:'Tap Factory',base:20000,gain:160,desc:'+160 SPS each',scale:1.17},
      {id:'server',name:'Click Server',base:140000,gain:900,desc:'+900 SPS each',scale:1.17},
      {id:'grid',name:'Auto Grid',base:900000,gain:6000,desc:'+6,000 SPS each',scale:1.18},
      {id:'lab',name:'Production Lab',base:6800000,gain:42000,desc:'+42,000 SPS each',scale:1.19},
      {id:'ai',name:'AI Operator',base:52000000,gain:300000,desc:'+300,000 SPS each',scale:1.20},
      {id:'megaplex',name:'Megaplex',base:4.1e8,gain:2.3e6,desc:'+2.3M SPS each',scale:1.20},
    ]

    const UPGRADES=[
      {id:'keys',name:'Mechanical Keys',base:150,gain:1,desc:'+1 SPC each',scale:1.15},
      {id:'switch',name:'Switch Plate',base:700,gain:5,desc:'+5 SPC each',scale:1.15},
      {id:'spring',name:'Premium Springs',base:2800,gain:20,desc:'+20 SPC each',scale:1.16},
      {id:'lub',name:'Nano Lube',base:16000,gain:120,desc:'+120 SPC each',scale:1.17},
      {id:'pcb',name:'Custom PCB',base:110000,gain:700,desc:'+700 SPC each',scale:1.18},
      {id:'caps',name:'Artisan Keycaps',base:800000,gain:4500,desc:'+4,500 SPC each',scale:1.19},
      {id:'sol',name:'Solenoid Booster',base:6.3e6,gain:32000,desc:'+32,000 SPC each',scale:1.20},
      {id:'aiassist',name:'AI Assist',base:4.7e7,gain:240000,desc:'+240,000 SPC each',scale:1.22},
    ]

    const ACH=[
      {id:'c1',title:'First Spark',desc:'Click once',cond:s=>s.totalClicks>=1},
      {id:'c100',title:'A Hundred Hands',desc:'Reach 100 clicks',cond:s=>s.totalClicks>=100},
      {id:'sps100',title:'Automation Unlocked',desc:'Get 100 SPS',cond:s=>s.sps>=100},
      {id:'spc100',title:'Fingers of Steel',desc:'Get 100 SPC',cond:s=>s.spc>=100},
      {id:'m1e6',title:'Six Zeroes',desc:'Reach 1e6 score',cond:s=>s.score>=1e6},
      {id:'m1e9',title:'Billion Sparks',desc:'Reach 1e9 score',cond:s=>s.score>=1e9},
  {id:'prest1',title:'Prestiger',desc:'Prestige once',cond:s=>s.prestige.lvl>=1},
    ]

    const COSMETICS=[
      {id:'c01',name:'Aurora',sw:'#47d3ff',apply:()=> setThemeColors('#0b1020','#0e1530','#47d3ff','#ff7ab3','#88ff6b')},
      {id:'c02',name:'Neon Rose',sw:'#ff7ab3',apply:()=> setThemeColors('#1a0b20','#2e1238','#ff7ab3','#ffd166','#47d3ff')},
      {id:'c03',name:'Verdant',sw:'#88ff6b',apply:()=> setThemeColors('#06120b','#0e3020','#88ff6b','#47d3ff','#ffd166')},
    ]

    /* ===================== Audio ===================== */
    const FX=(()=>{ let ctx=null,on=false
      const ensure=()=>{ if(!ctx){ try{ctx=new (window.AudioContext||window.webkitAudioContext)()}catch{} } }
      const beep=(f=720,d=.05,g=0.05,type='square')=>{ if(!on) return; ensure(); if(!ctx) return; const o=ctx.createOscillator(); const gg=ctx.createGain(); o.connect(gg); gg.connect(ctx.destination); o.frequency.value=f; o.type=type; gg.gain.setValueAtTime(g, ctx.currentTime); gg.gain.exponentialRampToValueAtTime(.0001, ctx.currentTime+d); o.start(); o.stop(ctx.currentTime+d) }
      return { set(v){ on=!!v; if(on) ensure() }, click(){ beep(820,.04,.06,'square') }, buy(){ beep(540,.06,.05,'sawtooth') }, err(){ beep(180,.08,.07,'triangle') }, star(){ beep(980,.25,.08,'sine') }, od(){ beep(620,.12,.08,'sawtooth') } }
    })()

    /* ===================== State ===================== */
    let S=load()
    let tick=null, clock=null
    let holding=false
    let combo=0, comboTO=null

    // daily modifier (seeded by date)
    const DAILY=computeDaily(S)

    /* ===================== Load/Save ===================== */
    function load(){
  // migrate from old key if present
  let s=Storage.get('hyperclicker-save', null) || Storage.get('starforge-save', null)
      s=s?JSON.parse(s):null
      if(!s||typeof s!=='object') s={...DEF}
      if(!s.v||s.v<VERSION){
        // migration path: adopt new prestige base/scale and add missing keys
        s={...DEF, ...s, v:VERSION}
        if(!s.prestige) s.prestige={lvl:0, stars:0, mult:1, base:PRESTIGE_BAL.base, scale:PRESTIGE_BAL.scale}
        if(!s.overdrive) s.overdrive={ readyAt:0, activeUntil:0, cooldown:20000, duration:7000 }
        if(typeof s.grid!=='boolean') s.grid=false
        if(typeof s.dailySeed!=='number') s.dailySeed=0
      }
      // offline gains
      const dt=Math.max(0, Math.floor((now()-(s.last||now()))/1000))
      if(dt>0 && s.sps>0){
        const off=Math.floor(s.sps*s.prestige.mult*dt)
        s.score+=off
        s.totalEarned+=off
      }
      s.last=now()
      return s
    }
  function save(){ S.last=now(); Storage.set('hyperclicker-save', JSON.stringify(S)) }

    /* ===================== Derived & Balance ===================== */
    const cost=(base,scale,own)=>Math.floor(base*Math.pow(scale,own))
  const owned=(k,id)=>S.owned[k]?.[id]||0
  const setOwned=(k,id,v)=>{ if(!S.owned[k]) S.owned[k]={}; S.owned[k][id]=v }

    function prestigeThreshold(){ return Math.floor((S.prestige?.base||PRESTIGE_BAL.base) * Math.pow((S.prestige?.scale||PRESTIGE_BAL.scale), S.prestige?.lvl||0)) }
    function perStar(){ const ramp=PRESTIGE_BAL.perLevelRamp* (S.prestige?.lvl||0); return Math.min(PRESTIGE_BAL.perStar + ramp, PRESTIGE_BAL.perStarCap) }
    function starsFromScore(sc){ const th=prestigeThreshold(); if(sc < th) return 0; const ratio=sc/th; return Math.max(1, Math.floor(Math.log10(ratio+1)*PRESTIGE_BAL.starScale)) }
    function recalc(){
      const m=S.prestige.mult * dailyMult()
  let sps=0; GENERATORS.forEach(it=> sps += (owned('generators',it.id))*it.gain)
  let spc=1; UPGRADES.forEach(it=> spc += (owned('upgrades',it.id))*it.gain)
      // Overdrive temporary bonus
      const odActive=now() < S.overdrive.activeUntil
      if(odActive){ spc=Math.floor(spc*1.8) }
      S.sps=Math.floor(sps*m)
      S.spc=Math.floor(spc*m)
    }

    /* ===================== DOM Bindings ===================== */
    const E={
      score:$('#score'), sps:$('#sps'), spc:$('#spc'), comboVal:$('#comboVal'),
      bigBtn:$('#bigBtn'), clickFx:$('#clickFx'), overlay:$('#overlay'), bg:$('#bg'),
  qtyBadges:$$('.badge[data-qty]'), comboBadge:$('#comboBadge'), critTag:$('#critTag'),
  tabs:$$('.tab'),
  sections:{ generators:$('#generators'), upgrades:$('#upgrades'), relics:$('#relics'), events:$('#events'), cosmetics:$('#cosmetics'), achv:$('#achv'), settings:$('#settings') },
      tEarn:$('#tEarn'), tClicks:$('#tClicks'), pTime:$('#pTime'),
      prestigeLvl:$('#prestigeLvl'), mult:$('#mult'), stars:$('#stars'), prestigeBtn:$('#prestigeBtn'),
      ascTarget:$('#ascTarget'), projStars:$('#projStars'), nextTarget:$('#nextTarget'), nextStars:$('#nextStars'),
      themeBtn:$('#themeBtn'), sfxBtn:$('#sfxBtn'), vfxBtn:$('#vfxBtn'), exportBtn:$('#exportBtn'), importBtn:$('#importBtn'), resetBtn:$('#resetBtn'),
      overdriveBadge:$('#overdriveBadge'), odStatus:$('#odStatus'), odCd:$('#odCd'), odBtn:$('#odBtn'),
      dailyBadge:$('#dailyBadge'), gridBadge:$('#gridBadge'),
    }

    /* ===================== Renderers ===================== */
    function ntext(el,v){ if(!el) return; if(el.textContent!==v){ el.textContent=v; el.classList.remove('pulse'); void el.offsetWidth; el.classList.add('pulse') } }
    function drawStats(){
      ntext(E.score, fmt(S.score));
      ntext(E.sps, fmt(S.sps));
      ntext(E.spc, fmt(S.spc));
      ntext(E.comboVal, 'x'+(1+Math.floor(combo/10)));
      ntext(E.ascTarget, fmt(prestigeThreshold()))
      ntext(E.projStars, '+'+starsFromScore(S.score))
    }
    function fmtTime(ms){ const s=Math.floor(ms/1000), h=Math.floor(s/3600), m=Math.floor((s%3600)/60), sec=s%60; if(h>0) return `${h}h ${m}m ${sec}s`; if(m>0) return `${m}m ${sec}s`; return `${sec}s` }
  function drawRight(){
      E.tEarn.textContent=fmt(S.totalEarned);
      E.tClicks.textContent=fmt(S.totalClicks);
      E.pTime.textContent=fmtTime(S.playMs);
      E.prestigeLvl.textContent=S.prestige.lvl;
      E.stars.textContent=S.prestige.stars;
      E.mult.textContent='x'+S.prestige.mult.toFixed(2);
      E.prestigeBtn.disabled=!canPrestige();
      E.nextTarget.textContent=fmt(prestigeThreshold())
      E.nextStars.textContent='+'+starsFromScore(S.score)
  const odActive = now()<S.overdrive.activeUntil
  const ready = now()>=S.overdrive.readyAt
  E.overdriveBadge.textContent = odActive? 'Frenzy: ON' : 'Frenzy: Off'
  E.odStatus.textContent = odActive? 'Active' : (ready ? 'Ready' : 'Cooling')
      const cd= Math.max(0, Math.ceil((S.overdrive.readyAt - now())/1000))
      E.odCd.textContent = cd+'s'
  if(E.odBtn){ E.odBtn.classList.toggle('ready', ready && !odActive) }
      E.dailyBadge.textContent = 'Daily Mod: '+DAILY.name
      E.gridBadge.textContent = 'Grid: '+(S.grid?'On':'Off')
    }

    function renderShop(kind,root,items){
      root.innerHTML=''
      const qty=S.qty
      items.forEach(it=>{
        const own=owned(kind,it.id)
        const next=cost(it.base,it.scale,own)
        const aff=affordable(kind,it,qty)
        const card=document.createElement('div'); card.className='card'; if(aff.units>0) card.classList.add('aff')
        card.append(
          el('div',{class:'title'}, it.name),
          el('div',{class:'desc'}, it.desc),
          row(el('span',{class:'owned'},`Owned: ${own}`), el('span',{class:'cost'}, qty==='1'?`Cost: ${fmt(next)}`:`Buy ${aff.units} for ${fmt(aff.total)}`)),
          row(btn(()=>buy(kind,it.id,qty), `Buy ${qty}`, aff.units<=0), btn(()=>info(kind,it),'Info',false,true))
        )
        root.appendChild(card)
      })
    }

    function renderRelics(){
      const r=E.sections.relics; r.innerHTML=''
      const rel=[
        {id:'r1', name:'Spark Capacitor', desc:'+2% global multiplier', apply:()=>{ S.prestige.mult*=1.02 } },
        {id:'r2', name:'Stellar Anvil', desc:'+3% SPC permanently', apply:()=>{ S.spc=Math.floor(S.spc*1.03) } },
        {id:'r3', name:'Time Kettle', desc:'+3% SPS permanently', apply:()=>{ S.sps=Math.floor(S.sps*1.03) } },
      ]
      rel.forEach(a=>{
        const owned=!!S.relics?.[a.id]
        const card=el('div',{class:'card'}, el('div',{class:'title'},a.name), el('div',{class:'desc'},a.desc), row(btn(()=>{ if(owned) return; S.relics[a.id]=now(); a.apply(); recalc(); drawStats(); drawRight(); save(); confetti() }, owned?'Owned':'Socket', owned, true)))
        r.appendChild(card)
      })
    }

  function renderEvents(){
      const r=E.sections.events; r.innerHTML=''
      const card=el('div',{class:'card'},
    el('div',{class:'title'},'Random Events'),
    el('div',{class:'desc'},'Boosts and freebies can appear. Click flying orbs for instant bonuses.'),
    row(btn(()=>{ spawnWormhole() }, 'Burst Bonus', false), btn(()=>{ supplyDrop() }, 'Free Upgrade', false))
      )
      r.appendChild(card)
    }

    function renderCosmetics(){
      const r=E.sections.cosmetics; r.innerHTML=''
      const grid=el('div',{class:'cos-grid'})
      COSMETICS.forEach(c=>{
        const sw=el('div',{class:'swatch'}); sw.style.background=c.sw
        const card=el('div',{class:'cos'}, el('strong',{},c.name), sw, el('button',{class:'btn apply'},'Apply'))
        card.querySelector('button').addEventListener('click',()=>{ c.apply(); save() })
        grid.appendChild(card)
      })
      r.appendChild(grid)
    }

    function renderAch(){ const r=E.sections.achv; r.innerHTML=''; ACH.forEach(a=>{ const got=!!S.ach[a.id]; const card=el('div',{class:'card'}, el('div',{class:'title'},a.title), el('div',{class:'desc'},a.desc), got?el('div',{class:'mono',style:'font-size:12px;color:var(--muted)'}, new Date(S.ach[a.id]).toLocaleString()):null); r.appendChild(card) }); checkAch() }

    function renderSettings(){
      const r=E.sections.settings; r.innerHTML=''
      r.append(
        sectionCard('Audio', row(btn(()=>{ S.sfx=!S.sfx; FX.set(S.sfx); E.sfxBtn.textContent='SFX: '+(S.sfx?'On':'Off'); save() }, S.sfx?'Disable':'Enable'))),
        sectionCard('Theme', row(btn(()=>{ toggleTheme() }, 'Toggle Theme'))),
        sectionCard('Grid Overlay', row(btn(()=>{ S.grid=!S.grid; applyGrid(); drawRight(); save() }, 'Toggle Grid'))),
        sectionCard('Save & Load', row(btn(exportSave,'Export'), btn(importSave,'Import'))),
        sectionCard('Danger Zone', row(btn(hardReset,'Hard Reset',false,true)))
      )
    }

    function sectionCard(title, ...children){ const d=el('div',{class:'card'}, el('div',{class:'title'},title)); children.forEach(c=>d.appendChild(c)); return d }

    function renderAll(){
      recalc(); drawStats(); drawRight();
  renderShop('generators',E.sections.generators,GENERATORS);
  renderShop('upgrades',E.sections.upgrades,UPGRADES);
      renderRelics(); renderEvents(); renderCosmetics(); renderAch(); renderSettings();
      markQty();
    }

    /* ===================== UI Helpers ===================== */
    function el(tag,props,...children){ const d=document.createElement(tag); Object.entries(props||{}).forEach(([k,v])=>{ if(k==='class') d.className=v; else if(k in d) d[k]=v; else d.setAttribute(k,v) }); children.flat().forEach(c=> d.appendChild(typeof c==='string'?document.createTextNode(c):c)); return d }
    function row(...a){ const r=el('div',{class:'row'}); a.forEach(x=>r.appendChild(x)); return r }
    function btn(on,text,disabled=false,ghost=false){ const b=el('button',{class:'btn'+(ghost?'':'')}); if(ghost) b.setAttribute('data-ghost',''); b.textContent=text; if(disabled) b.setAttribute('disabled',''); b.addEventListener('click',on); return b }

  function affordable(kind,it,qty){ const own=owned(kind,it.id), count=qty==='max'?1e6:Number(qty); let total=0,next=own,units=0; for(let i=0;i<count;i++){ const c=cost(it.base,it.scale,next); if(S.score<total+c) break; total+=c; next++; units++ } return {total,units} }

  function buy(kind,id,qty){ const list= kind==='generators'?GENERATORS: kind==='upgrades'?UPGRADES: null; if(!list) return; const it=list.find(x=>x.id===id); if(!it) return; const a=affordable(kind,it,qty); if(a.units<=0){ FX.err(); return } setOwned(kind,id,owned(kind,id)+a.units); S.score-=a.total; recalc(); save(); drawStats(); renderShop(kind,E.sections[kind], list); FX.buy(); flashSection(kind); confetti(); coinshower() }
  function info(kind,it){ alert(`${it.name}\n\nOwned: ${owned(kind,it.id)}\nNext Cost: ${fmt(cost(it.base,it.scale,owned(kind,it.id)))}\nGain per unit: ${fmt(it.gain)} ${kind==='generators'?'SPS':'SPC'}\nScale: x${it.scale}`) }

    /* ===================== Interactions ===================== */
    function clickGain(cx,cy){
      const od=now()<S.overdrive.activeUntil
      const cChance=Math.min(.35, .03 + combo*.002 + (od?0.08:0) + dailyCritBonus())
      const isCrit=Math.random()<cChance
      const m=S.prestige.mult * (1+Math.floor(combo/10)) * (isCrit?2:1) * dailyClickMult()
      const gain=Math.max(1, Math.floor(S.spc*m))
      S.score+=gain; S.totalEarned+=gain; S.totalClicks++
      drawStats(); save();
  ripple(cx,cy); floatText(cx,cy,`+${fmt(gain)}`, isCrit?'#f59e0b':'#60a5fa'); if(isCrit) critFx(cx,cy); FX.click()
      setCombo(combo+1)
      if(comboTO) clearTimeout(comboTO)
      comboTO=setTimeout(()=>setCombo(0), 2000)
    }

  function setCombo(v){ combo=Math.max(0,v); if(E.comboBadge) E.comboBadge.textContent='Combo x'+(1+Math.floor(combo/10)); if(E.comboVal) E.comboVal.textContent='x'+(1+Math.floor(combo/10)) }

    // Overdrive
    function canOverdrive(){ return now()>=S.overdrive.readyAt }
    function triggerOverdrive(){ if(!canOverdrive()) return; const t=now(); S.overdrive.activeUntil=t+S.overdrive.duration; S.overdrive.readyAt=S.overdrive.activeUntil+S.overdrive.cooldown; FX.od(); drawRight(); save(); overdriveBurst() }
    function overdriveBurst(){ confetti(); screenFlash('#ff7ab3'); shake() }

    // Tabs and qty
  function currentTab(){ return document.querySelector('.tab.active')?.dataset.tab || 'generators' }
    function setTab(id){ E.tabs.forEach(t=> t.classList.toggle('active', t.dataset.tab===id)); Object.entries(E.sections).forEach(([k,sec])=> sec.classList.toggle('active', k===id)) }
    function markQty(){ E.qtyBadges.forEach(b=> b.classList.toggle('active', String(b.dataset.qty)===S.qty)) }

    /* ===================== Prestige ===================== */
    const canPrestige=()=> S.score>=prestigeThreshold()
  function prestige(){ if(!canPrestige()) return false; const gained=starsFromScore(S.score); S.prestige.lvl+=1; S.prestige.stars+=gained; S.prestige.mult = computeMult(S.prestige.stars); S.score=0; S.owned={generators:{},upgrades:{}}; recalc(); FX.star(); save(); renderAll(); return true }
    function computeMult(stars){ return 1 + stars * perStar() }

    /* ===================== Events & Systems ===================== */
    // Meteors
    function meteors(){ setInterval(()=>{ if(Math.random()<.35) spawnMeteor() }, 4200) }
  function spawnMeteor(){ const m=el('div',{style:'position:fixed;width:26px;height:26px;border-radius:50%;background:radial-gradient(circle at 30% 30%,#fff,#f59e0b,#ef4444);box-shadow:0 0 18px #ef4444cc;z-index:5;pointer-events:auto;cursor:pointer;left:-40px;top:'+rnd(10,innerHeight*0.4)+'px'}); document.body.appendChild(m); const sx=-40, ex=innerWidth+80, dur=1800+rnd(0,600), t0=performance.now(); function step(t){ const p=Math.min(1,(t-t0)/dur); const x=sx+(ex-sx)*p; m.style.transform=`translate(${x-sx}px,${p*120}px)`; if(p<1) requestAnimationFrame(step); else m.remove() } requestAnimationFrame(step); m.addEventListener('click',()=>{ const bonus=Math.max(10, Math.floor(S.sps*7 + S.spc*15)); S.score+=bonus; S.totalEarned+=bonus; drawStats(); save(); confetti(); m.remove() }, {once:true}) }

    // Wormhole: timescore burst based on SPS
  function spawnWormhole(){ const bonus=Math.max(50, Math.floor(S.sps*20)); S.score+=bonus; S.totalEarned+=bonus; drawStats(); save(); confetti(); screenFlash('#4fd1c5') }

    // Supply drop: free lab item
  function supplyDrop(){ const item=UPGRADES[Math.floor(Math.random()*UPGRADES.length)]; setOwned('upgrades', item.id, owned('upgrades',item.id)+1); recalc(); renderShop('upgrades',E.sections.upgrades,UPGRADES); drawStats(); save(); floatText(innerWidth/2,120, '+1 '+item.name,'#34d399') }

    // Time Dilation: slight slow tick for dramatic effect (visual only)

    /* ===================== FX ===================== */
    let VFX=true
    function ripple(x,y){ if(!VFX||x==null||y==null) return; const r=document.createElement('div'); r.className='ripple'; const rect=E.bigBtn.getBoundingClientRect(); r.style.left=(x-rect.left)+'px'; r.style.top=(y-rect.top)+'px'; E.bigBtn.appendChild(r); setTimeout(()=>r.remove(),520) }
    function floatText(x,y,text,color){ if(!VFX||x==null||y==null) return; const s=el('div',{style:`position:fixed;left:${x+6}px;top:${y-10}px;color:${color};font-weight:800;text-shadow:0 0 8px ${color}88;z-index:6;animation:float .8s ease-out forwards`}, text); document.body.appendChild(s); setTimeout(()=>s.remove(),850) }
  function critFx(x,y){ if(!VFX||x==null||y==null) return; const d=el('div',{class:'critFx',style:`left:${x+10}px;top:${y-30}px`},'CRIT!'); document.body.appendChild(d); setTimeout(()=>d.remove(),920) }
    function flashSection(kind){ const root=E.sections[kind]; if(!root) return; root.classList.remove('flash'); void root.offsetWidth; root.classList.add('flash'); setTimeout(()=>root.classList.remove('flash'),520) }
    function confetti(x,y){ if(!VFX) return; for(let i=0;i<16;i++){ const c=el('div',{class:'confetti'}); c.style.background=['#47d3ff','#ff7ab3','#88ff6b','#ffd166','#a78bfa'][i%5]; c.style.setProperty('--cx',((Math.random()*2-1)*140)+'px'); c.style.setProperty('--cy',(40+Math.random()*60)+'px'); c.style.left=(x||innerWidth/2)+'px'; c.style.top=(y||130)+'px'; document.body.appendChild(c); setTimeout(()=>c.remove(),930) } }
    function screenFlash(color){ if(!VFX) return; const o=E.overlay; if(!o) return; o.style.background=color+'22'; setTimeout(()=> o.style.background='transparent',180) }
    function shake(){ if(!VFX) return; const core=$('#core'); if(!core) return; const orig=core.style.transform; let i=0; const iv=setInterval(()=>{ core.style.transform=`translate(${Math.sin(i)*3}px, ${Math.cos(i)*3}px)`; i+=.6; if(i>6){ clearInterval(iv); core.style.transform=orig||'' } }, 16) }

  // Coin shower on purchases
  function coinshower(){ if(!VFX) return; const cx=innerWidth-220, cy=180; for(let i=0;i<18;i++){ const c=el('div',{class:'coin'}); c.style.left=cx+'px'; c.style.top=cy+'px'; c.style.setProperty('--cx', ((Math.random()*2-1)*160)+'px'); c.style.setProperty('--cy', (40+Math.random()*80)+'px'); document.body.appendChild(c); setTimeout(()=>c.remove(),950) } }

  // Mouse particle trail
  let trailTO=null
  document.addEventListener('mousemove', (e)=>{ if(!VFX) return; if(trailTO) cancelAnimationFrame(trailTO); const x=e.clientX, y=e.clientY; for(let i=0;i<2;i++){ const t=el('div',{class:'trail'}); t.style.left=(x+Math.random()*6-3)+'px'; t.style.top=(y+Math.random()*6-3)+'px'; document.body.appendChild(t); setTimeout(()=>t.remove(),520) } })

  // Bokeh background
  function starfield(){ const c=E.bg; if(!c) return; const dpr=Math.max(1,window.devicePixelRatio||1); const ctx=c.getContext('2d'); const resize=()=>{ c.width=innerWidth*dpr; c.height=innerHeight*dpr }; resize(); window.addEventListener('resize',resize); const balls=new Array(40).fill(0).map(()=>({x:Math.random()*c.width,y:Math.random()*c.height,r:(Math.random()*30+10)*dpr,s:(Math.random()*.4+.1),h:Math.floor(Math.random()*360)})); let last=now(); (function loop(){ requestAnimationFrame(loop); const t=now(), dt=(t-last)/16.6; last=t; ctx.clearRect(0,0,c.width,c.height); for(const b of balls){ b.y+=b.s*dt*8; if(b.y-b.r>c.height){ b.y=-b.r; b.x=Math.random()*c.width } const g=ctx.createRadialGradient(b.x,b.y,b.r*0.1,b.x,b.y,b.r); g.addColorStop(0,`hsla(${b.h},70%,70%,.35)`); g.addColorStop(1,`hsla(${b.h},70%,70%,0)`); ctx.fillStyle=g; ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill() } })() }

    /* ===================== Daily Modifier ===================== */
    function computeDaily(s){
      const d=new Date(); const seed= Number(`${d.getUTCFullYear()}${(d.getUTCMonth()+1).toString().padStart(2,'0')}${d.getUTCDate().toString().padStart(2,'0')}`)
      s.dailySeed=seed
      const r=seed%3
      if(r===0) return {name:'Hyper Crit', crit:0.06, click:1.0, mult:1.0}
      if(r===1) return {name:'Heavy Clicks', crit:0.0, click:1.2, mult:0.95}
      return {name:'Automation Day', crit:0.0, click:1.0, mult:1.05}
    }
    function dailyCritBonus(){ return DAILY.crit||0 }
    function dailyClickMult(){ return DAILY.click||1 }
    function dailyMult(){ return DAILY.mult||1 }

    /* ===================== Theme & Grid ===================== */
    function toggleTheme(){ S.theme=S.theme==='dark'?'light':'dark'; applyTheme(); save() }
    function applyTheme(){ if(S.theme==='light') document.body.classList.add('theme-light'); else document.body.classList.remove('theme-light') }
    function setThemeColors(bg,bg2,a1,a2,a3){ document.documentElement.style.setProperty('--bg',bg); document.documentElement.style.setProperty('--bg2',bg2); document.documentElement.style.setProperty('--a1',a1); document.documentElement.style.setProperty('--a2',a2); document.documentElement.style.setProperty('--a3',a3) }
    function applyGrid(){ document.body.style.backgroundImage= S.grid? `linear-gradient(0deg, rgba(255,255,255,0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px), radial-gradient(1400px 900px at 20% -10%, var(--bg2), var(--bg))` : `radial-gradient(1400px 900px at 20% -10%, var(--bg2), var(--bg))`; document.body.style.backgroundSize= S.grid? '40px 40px, 40px 40px, auto' : 'auto' }

    /* ===================== Controls ===================== */
    E.bigBtn.addEventListener('click',e=> clickGain(e.clientX,e.clientY))
    E.bigBtn.addEventListener('keydown',e=>{ if(e.code==='Space'||e.key===' '){ e.preventDefault(); if(!holding){ holding=true; clickGain() } } })
    document.addEventListener('keydown',e=>{
      if(e.code==='Space'){ e.preventDefault(); if(!holding){ holding=true; clickGain() } }
  if(e.key==='1') setTab('generators')
  if(e.key==='2') setTab('upgrades')
      if(e.key==='3') setTab('relics')
      if(e.key==='4') setTab('events')
      if(e.key==='5') setTab('cosmetics')
      if(e.key==='6') setTab('achv')
      if(e.key==='7') setTab('settings')
  if(e.key==='Enter'){ const t=currentTab(); const items=t==='generators'?GENERATORS: t==='upgrades'?UPGRADES: null; if(items){ for(const it of items){ const a=affordable(t,it,S.qty); if(a.units>0){ buy(t,it.id,S.qty); break } } } }
  if(e.key.toLowerCase()==='f') triggerOverdrive()
      if(e.key.toLowerCase()==='g'){ S.grid=!S.grid; applyGrid(); drawRight(); save() }
      if(e.shiftKey){ /* simple rapid-fire accelerator handled by holding flag */ }
    })
    document.addEventListener('keyup',e=>{ if(e.code==='Space'){ e.preventDefault(); holding=false } })

    E.qtyBadges.forEach(b=> b.addEventListener('click',()=>{ S.qty=String(b.dataset.qty); markQty(); renderAll(); save() }))
  E.tabs.forEach(t=> t.addEventListener('click',()=> setTab(t.dataset.tab)))
    E.prestigeBtn.addEventListener('click',()=>{ if(prestige()){} drawRight() })
    E.themeBtn.addEventListener('click',toggleTheme)
    E.sfxBtn.addEventListener('click',()=>{ S.sfx=!S.sfx; FX.set(S.sfx); E.sfxBtn.textContent='SFX: '+(S.sfx?'On':'Off'); save() })
    E.vfxBtn.addEventListener('click',()=>{ VFX=!VFX; S.vfx=VFX; E.vfxBtn.textContent='VFX: '+(VFX?'On':'Off'); save() })
    E.exportBtn.addEventListener('click',exportSave)
    E.importBtn.addEventListener('click',importSave)
    E.resetBtn.addEventListener('click',hardReset)
    E.odBtn.addEventListener('click', triggerOverdrive)

  function exportSave(){ const data=btoa(unescape(encodeURIComponent(JSON.stringify(S)))); navigator.clipboard?.writeText(data); alert('Save copied to clipboard') }
  function importSave(){ const tx=prompt('Paste save:'); if(!tx) return; try{ const s=JSON.parse(decodeURIComponent(escape(atob(tx)))); S={...DEF,...s}; if(!S.owned?.generators&&S.owned?.fleet){ S.owned.generators=S.owned.fleet; delete S.owned.fleet } if(!S.owned?.upgrades&&S.owned?.lab){ S.owned.upgrades=S.owned.lab; delete S.owned.lab } save(); renderAll() }catch{ alert('Invalid save') } }
    function hardReset(){ if(!confirm('Hard reset all progress?')) return; S={...DEF}; save(); renderAll() }

    /* ===================== Loops ===================== */
    function start(){
      if(tick) clearInterval(tick)
      tick=setInterval(()=>{
        if(S.sps>0){ S.score+=S.sps; S.totalEarned+=S.sps; drawStats(); save() } else S.last=now()
        // overdrive cooldown UI tick
        drawRight()
      }, 1000)
      if(clock) clearInterval(clock)
      let last=now();
      clock=setInterval(()=>{ const t=now(); S.playMs+=(t-last); last=t; if((S.playMs/1000)%5<1) drawRight() }, 1000)
    }

    /* ===================== Achievements ===================== */
    function checkAch(){ let any=false; ACH.forEach(a=>{ if(S.ach[a.id]) return; if(a.cond(S)){ S.ach[a.id]=now(); any=true } }); if(any){ save(); renderAch() } }

    /* ===================== Boot ===================== */
  function boot(){ applyTheme(); applyGrid(); FX.set(S.sfx); E.sfxBtn.textContent='SFX: '+(S.sfx?'On':'Off'); VFX=S.vfx; E.vfxBtn.textContent='VFX: '+(VFX?'On':'Off'); renderAll(); start(); starfield(); meteors(); checkAch(); setTab('generators') }
    boot()

  })()
  </script>
</body>
</html>

