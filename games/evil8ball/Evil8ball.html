<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Evil Magic 8 Ball ‚Äî Revamped</title>
    <link rel="icon" type="image/png" sizes="16x16" href="../../favicon_16x16.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="../../favicon_32x32.png" />
    <link rel="icon" type="image/png" sizes="256x256" href="../../favicon_256x256.png" />
    <style>
        :root {
            --bg: #0b1020;
            --panel: #111827;
            --panel-2: #0b1320;
            --text: #e5e7eb;
            --muted: #9ca3af;
            --accent: #38bdf8;
            --good: #22c55e;
            --bad: #ef4444;
            --cheeky: #f59e0b;
            --evil: #a855f7;
            --shadow: 0 12px 30px rgba(0,0,0,0.45);
            --sai-top: env(safe-area-inset-top, 0px);
            --sai-right: env(safe-area-inset-right, 0px);
            --sai-bottom: env(safe-area-inset-bottom, 0px);
            --sai-left: env(safe-area-inset-left, 0px);
        }

        * { box-sizing: border-box; }
        html, body { height: 100%; }
        body {
            margin: 0;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial;
            color: var(--text);
            background:
                radial-gradient(1200px 600px at 10% -10%, #1f2937 0%, transparent 60%),
                radial-gradient(1000px 500px at 110% 10%, #0b1320 0%, transparent 60%),
                linear-gradient(160deg, #0b1020, #0f172a 55%, #0a0f1f);
            display: grid;
            place-items: center;
            padding: 24px;
            overflow-x: hidden;
        }

        #bgCanvas { position: fixed; inset: 0; z-index: 0; pointer-events: none; display: block; will-change: transform; }
        .aurora { position: fixed; inset: -20% -10% 0 -10%; z-index: 0; pointer-events: none; opacity: 0.55; filter: blur(22px) saturate(1.1); mix-blend-mode: screen; }
        .aurora::before, .aurora::after { content:""; position:absolute; inset:auto; border-radius:50%;}
        .aurora::before { width: 60vw; height: 60vw; left: -10vw; top: 10vh; background: radial-gradient(closest-side, rgba(59,130,246,.18), rgba(59,130,246,0) 70%); animation: auroraA 22s ease-in-out infinite alternate; }
        .aurora::after { width: 55vw; height: 55vw; right: -8vw; top: 30vh; background: radial-gradient(closest-side, rgba(236,72,153,.18), rgba(236,72,153,0) 70%); animation: auroraB 26s ease-in-out infinite alternate; }
        @keyframes auroraA { from { transform: translateY(-6vh);} to { transform: translateY(6vh);} }
        @keyframes auroraB { from { transform: translateY(5vh);} to { transform: translateY(-5vh);} }

        .app { position: relative; z-index: 1; width: 100%; max-width: 760px; display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 16px; }
        @media (max-width: 820px) { .app { grid-template-columns: 1fr; max-width: 560px; } }

        .card { background: linear-gradient(180deg, var(--panel), var(--panel-2)); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; box-shadow: var(--shadow); overflow: clip; }
        .header { padding: 18px 18px 0 18px; }
        .title { margin: 0; font-size: 24px; letter-spacing: .5px; position: relative; }
        .title::after { content: ""; position: absolute; left: 0; bottom: -8px; width: 72px; height: 3px; border-radius: 3px; background: linear-gradient(90deg, var(--accent), transparent); opacity: .7; }
        .subtitle { margin: 6px 0 0; color: var(--muted); font-size: 14px; }
        .body { padding: 16px 18px 18px; }
        .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        @media (max-width: 480px) { .grid-2 { grid-template-columns: 1fr; } }

        input[type="text"], select, button { appearance: none; border-radius: 10px; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.06); color: var(--text); padding: 10px 12px; font-size: 14px; outline: none; transition: transform .06s ease, background .2s ease, border-color .2s ease; }
        input:hover, select:hover, button:hover { border-color: rgba(255,255,255,0.22); }
        input:focus, select:focus { box-shadow: 0 0 0 2px rgba(56,189,248,.25); }
        .btn { cursor: pointer; position: relative; overflow: hidden; }
        .btn:active { transform: translateY(1px); }
        .btn-primary { background: linear-gradient(180deg, #22c55e, #16a34a); border: 0; color: #fff; }
        .btn-accent { background: linear-gradient(180deg, #38bdf8, #0ea5e9); border: 0; color: #001018; }
        .btn-ghost { background: transparent; }
        .btn[disabled] { opacity:.6; cursor:not-allowed; }
        .kbd { font-family: ui-monospace, Menlo, Consolas, monospace; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.12); padding: 2px 6px; border-radius: 6px; font-size: 12px; }

        .ball-wrap { display: grid; place-items: center; padding: 8px 0 2px; }
        .ball { width: 170px; height: 170px; border-radius: 50%; background: radial-gradient(102px 102px at 40% 35%, #1f2937, #000 60%); box-shadow: inset -14px -16px 36px rgba(0,0,0,0.8), inset 10px 8px 22px rgba(255,255,255,0.06), 0 18px 54px rgba(0,0,0,0.6); display: grid; place-items: center; transform-style: preserve-3d; transition: transform .15s ease; }
        .window { width: 95px; height: 95px; border-radius: 50%; background: radial-gradient(60px 60px at 50% 45%, #0b1e4a, #020b1e 65%); box-shadow: inset 0 0 18px rgba(0,0,0,0.75), 0 0 0 5px rgba(0,0,0,0.35); display: grid; place-items: center; overflow: hidden; position: relative; }
        .tri { width: 0; height: 0; border-left: 40px solid transparent; border-right: 40px solid transparent; border-top: 72px solid #0ea5e9; filter: drop-shadow(0 5px 16px rgba(14,165,233,.25)); transform: translateY(10px); }
        .ans { position: absolute; top: 50%; left: 50%; transform: translate(-50%, calc(-50% + 6px)); width: 70px; text-align: center; font-size: 11px; color: #dff6ff; text-transform: uppercase; letter-spacing: .6px; font-weight: 700; }
        .badge { position:absolute; right: 8px; top: 8px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.12); padding: 4px 8px; border-radius: 999px; font-size: 12px; color: var(--muted); }

        .ball.good { box-shadow: inset -16px -18px 40px rgba(0,0,0,0.8), inset 12px 10px 24px rgba(255,255,255,0.06), 0 0 60px rgba(34,197,94,0.35), 0 20px 60px rgba(0,0,0,0.6); }
        .ball.bad { box-shadow: inset -16px -18px 40px rgba(0,0,0,0.8), inset 12px 10px 24px rgba(255,255,255,0.06), 0 0 60px rgba(239,68,68,0.35), 0 20px 60px rgba(0,0,0,0.6); }
        .ball.cheeky { box-shadow: inset -16px -18px 40px rgba(0,0,0,0.8), inset 12px 10px 24px rgba(255,255,255,0.06), 0 0 60px rgba(245,158,11,0.35), 0 20px 60px rgba(0,0,0,0.6); }
        .ball.evil { box-shadow: inset -16px -18px 40px rgba(0,0,0,0.8), inset 12px 10px 24px rgba(255,255,255,0.06), 0 0 70px rgba(168,85,247,0.45), 0 20px 60px rgba(0,0,0,0.6); }

        .answer-box { min-height: 46px; display: grid; align-content: center; border-radius: 12px; background: rgba(56,189,248,0.08); border: 1px solid rgba(56,189,248,0.18); padding: 8px 12px; color: #c7e9ff; font-size: 14px; margin-top: 12px; }
        .answer-box.shake { animation: shake .45s; }
        @keyframes shake { 10%, 90% { transform: translateX(-1px);} 20%, 80% { transform: translateX(2px);} 30%, 50%, 70% { transform: translateX(-4px);} 40%, 60% { transform: translateX(4px);} }

        .history { display:grid; gap:8px; }
        .history .item { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); border-radius: 10px; padding: 8px 10px; }
        .history .q { color: var(--muted); font-size: 12px; }
        .history .a { font-size: 14px; }

        .modal-backdrop { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.55); padding: 16px; z-index: 40; }
        .modal .body { max-height: 70vh; overflow:auto; }

        .flash { position: fixed; inset: 0; background: rgba(255,255,255,0.0); pointer-events: none; z-index: 30; }
        .flash.active { animation: flash 0.5s ease-out; }
        @keyframes flash { 0%{ background: rgba(255,255,255,0.0);} 20%{ background: rgba(255,255,255,0.35);} 100%{ background: rgba(255,255,255,0.0);} }

        .glitch { animation: glitch 0.32s ease-in-out; }
        @keyframes glitch { 0%{ transform: skewX(0deg);} 30%{ transform: skewX(6deg);} 60%{ transform: skewX(-6deg);} 100%{ transform: skewX(0deg);} }

        .toast-layer { position: fixed; right: 12px; top: 12px; z-index: 60; }
        .toast { background: rgba(17,24,39,0.88); color: #e5e7eb; border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 8px 12px; margin-bottom: 8px; box-shadow: 0 10px 24px rgba(0,0,0,0.35); }
        .homeBtn { position: fixed; left: 10px; top: 10px; z-index: 80; display:inline-flex; align-items:center; gap:6px; padding:8px 10px; border-radius:10px; background: rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.16); color:#e5e7eb; text-decoration:none; font-weight:700; backdrop-filter: blur(6px); }
        .homeBtn:hover{ background: rgba(255,255,255,0.16); }

        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
            input, select, textarea { font-size: 16px !important; }
        }

        @media (max-width: 414px) {
            body { padding: 16px; }
            .card { margin-bottom: 12px; }
            #question { font-size: 16px; }
        }

        @media (max-width: 375px) {
            body { font-size: 14px; }
            .btn { font-size: 14px; padding: 10px 14px; }
            .ball { width: 180px; height: 180px; }
        }

        @media (hover: none) and (pointer: coarse) {
            button, .btn { min-height: 48px; min-width: 48px; padding: 14px 18px; }
            #question { min-height: 48px; font-size: 16px; }
        }
    </style>
</head>
<body>
    <canvas id="bgCanvas"></canvas>
    <div class="aurora" aria-hidden="true"></div>
    <a class="homeBtn" href="../../index.html" aria-label="Home">üè† Home</a>
    <div class="flash" id="flash" aria-hidden="true"></div>
    <div class="toast-layer" id="toastLayer" aria-live="polite" aria-atomic="true"></div>

    <main class="app" aria-label="Evil Magic 8 Ball">
        <section class="card" aria-labelledby="t1">
            <header class="header">
                <h1 id="t1" class="title">Evil Magic 8 Ball</h1>
                <p class="subtitle">Ask a question, shake the ball, and get a mischievous answer. It‚Äôs for fun‚Äîdon‚Äôt take it seriously.</p>
            </header>
            <div class="body">
                <div class="ball-wrap">
                    <div class="ball" id="ball" aria-hidden="true">
                        <div class="window">
                            <div class="tri"></div>
                            <div class="ans" id="ans">8</div>
                            <div class="badge" id="badge">‚Äî</div>
                        </div>
                    </div>
                </div>

                <div class="grid-2" aria-label="Ask a question">
                    <input id="question" type="text" placeholder="Type your question..." aria-label="Your question" />
                    <div class="row">
                        <button id="askBtn" class="btn btn-primary">Ask <span class="kbd" aria-hidden="true">Enter</span></button>
                        <button id="shakeBtn" class="btn btn-ghost" title="Shake the ball">Shake</button>
                    </div>
                </div>

                <div class="row" style="margin-top:8px;">
                    <button id="speakBtn" class="btn btn-ghost" aria-pressed="false">Voice: Off</button>
                    <button id="copyBtn" class="btn btn-accent">Copy Answer</button>
                    <button id="clearBtn" class="btn btn-ghost">Clear</button>
                    <button id="aboutBtn" class="btn btn-ghost" aria-haspopup="dialog" aria-controls="aboutModal">About</button>
                </div>

                <div id="answerBox" class="answer-box" role="status" aria-live="polite">Ask anything to begin.</div>
            </div>
        </section>

        <aside class="card" aria-labelledby="t2">
            <header class="header">
                <h2 id="t2" class="title">History</h2>
                <p class="subtitle">Your recent questions and answers</p>
            </header>
            <div class="body">
                <div id="history" class="history" aria-live="polite"></div>
            </div>
        </aside>
    </main>

        
        <div id="disclaimer" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="dTitle" aria-hidden="true">
            <div class="card modal" style="max-width:560px;">
                <header class="header">
                    <h2 id="dTitle" class="title">Heads up</h2>
                    <p class="subtitle">For entertainment only. Don‚Äôt take the answers seriously.</p>
                </header>
                <div class="body">
                    <p>By continuing you agree this app is just for fun and you won‚Äôt follow its ‚Äúadvice‚Äù.</p>
                    <div class="row" style="justify-content:flex-end;">
                        <button id="closeDisclaimer" class="btn btn-primary">Continue</button>
                    </div>
                </div>
            </div>
        </div>

    
    <div id="aboutModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="aTitle" aria-hidden="true">
        <div class="card modal" style="max-width:640px;">
            <header class="header">
                <h2 id="aTitle" class="title">About</h2>
                <p class="subtitle">How answers are picked and what the colors mean.</p>
            </header>
            <div class="body">
                <ul>
                    <li>Categories: <strong style="color:var(--good)">Positive</strong>, <strong style="color:var(--bad)">Negative</strong>, <strong style="color:var(--cheeky)">Uncertain</strong>, and rare <strong style="color:var(--evil)">Evil</strong>.</li>
                    <li>Weights: Positive ~10%, Negative ~60%, Uncertain ~20%, Evil ~10% (still varies a bit with your wording).</li>
                    <li>Understands simple negation: ‚ÄúShould I X?‚Äù vs ‚ÄúShould I not X?‚Äù produce opposite yes/no.</li>
                    <li>Tip: Add words like ‚Äúnot/never/shouldn‚Äôt‚Äù to skew negative, or ‚Äúshould/can/will‚Äù to skew positive.</li>
                    <li>History stores your last 20 Q&A on this device.</li>
                    <li>Voice uses your browser‚Äôs speech synthesis if enabled.</li>
                </ul>
                <div class="row" style="justify-content:flex-end; margin-top:8px;">
                    <button id="closeAbout" class="btn btn-primary">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    (function(){
        'use strict';

        const $ = (s) => document.querySelector(s);
        const els = {
            bg: $('#bgCanvas'),
            aur: $('.aurora'),
            ball: $('#ball'),
            ans: $('#ans'),
            badge: $('#badge'),
            answerBox: $('#answerBox'),
            question: $('#question'),
            askBtn: $('#askBtn'),
            shakeBtn: $('#shakeBtn'),
            speakBtn: $('#speakBtn'),
            copyBtn: $('#copyBtn'),
            clearBtn: $('#clearBtn'),
            aboutBtn: $('#aboutBtn'),
            aboutModal: $('#aboutModal'),
            closeAbout: $('#closeAbout'),
            hist: $('#history'),
            toastLayer: $('#toastLayer'),
            flash: $('#flash'),
            disclaimer: $('#disclaimer'),
            closeDisclaimer: $('#closeDisclaimer'),
        };

        const storage = {
            get(k, f){ try{ const v=localStorage.getItem(k); return v==null?f:JSON.parse(v);}catch{return f;}},
            set(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} }
        };
        const state = {
            voice: storage.get('e8_voice', false),
            history: storage.get('e8_hist', []),
            acknowledged: storage.get('e8_ack', false),
        };

        const ANSWERS = {
            positive: [
                'Absolutely.', 'Without a doubt.', 'It is certain.', 'You may rely on it.', 'Signs point to yes.', 'Go for it.', 'Yes‚Äîdefinitely.', 'It looks good.',
            ],
            negative: [
                "Don't count on it.", 'Very doubtful.', 'My reply is no.', 'Outlook not so good.', 'Nope.', 'I wouldn\'t.', 'It\'s unlikely.', 'Not a chance.',
                'Absolutely not.', 'The stars say no.', 'Odds look terrible.', 'Outlook grim.', 'Denied.', 'Hard pass.', 'Try again never.',
            ],
            cheeky: [
                'Ask again later.', 'Better not tell you now.', 'Reply hazy‚Äîtry again.', 'Concentrate and ask again.', 'Define ‚Äúquestion‚Äù.', 'I could, but why?', 'Plot twist: maybe.',
                'Lol, no idea.', 'You first.', 'That\'s classified.',
            ],
            evil: [
                'Heh. You\'ll see.', 'Chaos approves.', 'I know, but I\'m not telling.', 'Beware the consequences.', 'A delicious disaster awaits.', 'Proceed... if you dare.',
                'The void whispers ‚Äúno‚Äù.', 'Suffer the suspense.', 'I choose violence‚Äîkidding. Just no.', 'I foresaw this... disaster.',
            ],
        };

        const YES_NEGATE_POOL = [
            'Yes.', 'Yes‚Äîskip it.', 'Yes, avoid that.', 'Yes. Sit this one out.',
        ];
        const NO_ACTION_POOL = [
            'No.', 'Nope.', 'Absolutely not.', 'Hard no.',
        ];

        const rand = (arr)=> arr[Math.floor(Math.random()*arr.length)];

        function toast(msg){
            if(!els.toastLayer) return;
            const d = document.createElement('div'); d.className = 'toast'; d.textContent = msg; els.toastLayer.appendChild(d);
            setTimeout(()=>d.remove(), 2800);
        }

        function setCategoryGlow(cat){
            els.ball.classList.remove('good','bad','cheeky','evil');
            const map = {positive:'good', negative:'bad', cheeky:'cheeky', evil:'evil'};
            els.ball.classList.add(map[cat]||'');
            els.badge.textContent = ({positive:'Positive', negative:'Negative', cheeky:'Uncertain', evil:'Evil'})[cat] || '‚Äî';
        }

        function speak(text){
            if(!state.voice) return;
            try {
                const u = new SpeechSynthesisUtterance(text);
                u.rate = 1; u.pitch = 1; u.volume = 1; u.lang = navigator.language || 'en-US';
                window.speechSynthesis.cancel();
                window.speechSynthesis.speak(u);
            } catch {}
        }

        function pickCategory(q){
            let w = { positive: 0.10, negative: 0.60, cheeky: 0.20, evil: 0.10 };
            const s = (q||'').toLowerCase();
            if(/\b(not|never|can\'t|dont|don\'t|shouldn\'t|won\'t|no way)\b/.test(s)) { w.negative += 0.20; w.evil += 0.05; w.positive -= 0.08; }
            if(/\b(should|can|will|could|may|am i|do i|is it|will i)\b/.test(s)) { w.negative += 0.10; w.cheeky += 0.05; w.positive -= 0.08; }
            if(/\b(why|how|what|when|where|explain)\b/.test(s)) { w.cheeky += 0.08; }
            if(Math.random() < 0.20){ w.evil += 0.06; w.negative += 0.04; }
            for(const k of ['positive','negative','cheeky','evil']){ w[k] = Math.max(0.001, w[k]); }
            const sum = w.positive + w.negative + w.cheeky + w.evil;
            let r = Math.random() * sum;
            for (const k of ['positive','negative','cheeky','evil']) { if ((r -= w[k]) <= 0) return k; }
            return 'negative';
        }

        function pickAnswer(cat){
            const arr = ANSWERS[cat] || ANSWERS.cheeky; return arr[Math.floor(Math.random()*arr.length)];
        }

        function parseYesNo(q){
            const s = (q||'').trim().toLowerCase();
            const ynStart = /^(\s*)(should|can|will|would|could|may|do|does|did|is|are|am|was|were)\b/.test(s);
            if(!ynStart) return { yn:false };
            const neg = /(\bnot\b|\bnever\b|don'?t\b|do not\b|can'?t\b|won'?t\b|shouldn'?t\b|isn'?t\b|aren'?t\b|wasn'?t\b|weren'?t\b|doesn'?t\b|didn'?t\b|wouldn'?t\b|couldn'?t\b)/.test(s);
            return { yn:true, negated: neg };
        }

        function smartAnswer(q){
            const p = parseYesNo(q);
            if(!p.yn) return null;
            const wantYes = p.negated;
            if(wantYes){
                const cat = Math.random()<0.5 ? 'evil' : 'negative';
                return { cat, text: rand(YES_NEGATE_POOL) };
            } else {
                const cat = Math.random()<0.7 ? 'negative' : 'evil';
                return { cat, text: rand(NO_ACTION_POOL) };
            }
        }

        function renderHistory(){
            if(!els.hist) return;
            els.hist.innerHTML = '';
            const items = state.history.slice(-20).slice().reverse();
            for (const it of items) {
                const d = document.createElement('div'); d.className = 'item';
                const q = document.createElement('div'); q.className = 'q'; q.textContent = new Date(it.t).toLocaleString() + ' ‚Äî ' + it.q;
                const a = document.createElement('div'); a.className = 'a'; a.textContent = it.a + ` (${it.c})`;
                d.append(q,a); d.title = 'Click to speak again';
                d.addEventListener('click', ()=>speak(it.a));
                els.hist.appendChild(d);
            }
        }

        function saveHistory(){ storage.set('e8_hist', state.history.slice(-20)); }

        function setAnswer(cat, text){
            setCategoryGlow(cat);
            els.ans.textContent = text.toUpperCase();
            els.answerBox.textContent = text;
            els.answerBox.classList.remove('shake','glitch');
            void els.answerBox.offsetWidth;
            els.answerBox.classList.add('shake');
            if (cat==='evil') els.answerBox.classList.add('glitch');
            if (cat==='negative') { els.flash.classList.remove('active'); void els.flash.offsetWidth; els.flash.classList.add('active'); }
        }

        function animateBall(){
            els.ball.animate([
                { transform: 'translateZ(0) rotate(0deg)' },
                { transform: 'translateZ(0) rotate(6deg)' },
                { transform: 'translateZ(0) rotate(-6deg)' },
                { transform: 'translateZ(0) rotate(3deg)' },
                { transform: 'translateZ(0) rotate(0deg)' },
            ], { duration: 500, easing: 'ease-in-out' });
        }

        function ask(){
            const q = (els.question.value || '').trim();
            if (!q) { toast('Type a question first.'); els.question.focus(); return; }
            animateBall();
            const smart = smartAnswer(q);
            if(smart){
                setAnswer(smart.cat, smart.text);
                speak(smart.text);
                state.history.push({ q, a:smart.text, c:smart.cat, t: Date.now() }); saveHistory(); renderHistory();
                return;
            }
            const cat = pickCategory(q);
            const a = pickAnswer(cat);
            setAnswer(cat, a);
            speak(a);
            state.history.push({ q, a, c:cat, t: Date.now() }); saveHistory(); renderHistory();
        }

        els.askBtn.addEventListener('click', ask);
        els.shakeBtn.addEventListener('click', ()=>{ animateBall(); setTimeout(ask, 120); });
        els.question.addEventListener('keydown', (e)=>{ if(e.key==='Enter') ask(); });
        els.copyBtn.addEventListener('click', async ()=>{
            const txt = els.answerBox.textContent || '';
            try { await navigator.clipboard.writeText(txt); toast('Answer copied.'); } catch { toast(txt); }
        });
        els.clearBtn.addEventListener('click', ()=>{ els.question.value=''; els.answerBox.textContent='Ask anything to begin.'; els.ans.textContent='8'; setCategoryGlow(null); });
        els.speakBtn.addEventListener('click', ()=>{ state.voice = !state.voice; storage.set('e8_voice', state.voice); els.speakBtn.textContent = 'Voice: ' + (state.voice? 'On' : 'Off'); els.speakBtn.setAttribute('aria-pressed', String(state.voice)); });

        const openAbout = ()=>{ els.aboutModal.style.display='flex'; els.aboutModal.setAttribute('aria-hidden','false'); };
        const closeAbout = ()=>{ els.aboutModal.style.display='none'; els.aboutModal.setAttribute('aria-hidden','true'); };
        els.aboutBtn.addEventListener('click', openAbout);
        els.closeAbout.addEventListener('click', closeAbout);
        els.aboutModal.addEventListener('click', (e)=>{ if(e.target===els.aboutModal) closeAbout(); });

        function openDisclaimer(){ els.disclaimer.style.display='flex'; els.disclaimer.setAttribute('aria-hidden','false'); }
        function closeDisclaimer(){ els.disclaimer.style.display='none'; els.disclaimer.setAttribute('aria-hidden','true'); }
        els.closeDisclaimer.addEventListener('click', ()=>{ state.acknowledged = true; storage.set('e8_ack', true); closeDisclaimer(); toast('Enjoy responsibly.'); els.question.focus(); });

        els.speakBtn.textContent = 'Voice: ' + (state.voice? 'On' : 'Off');
        renderHistory();
        if (!state.acknowledged) openDisclaimer();

        els.ball.addEventListener('mousemove', (e)=>{
            const r = els.ball.getBoundingClientRect();
            const dx = (e.clientX - (r.left + r.width/2)) / (r.width/2);
            const dy = (e.clientY - (r.top + r.height/2)) / (r.height/2);
            els.ball.style.transform = `rotateX(${dy*-6}deg) rotateY(${dx*6}deg)`;
        });
        els.ball.addEventListener('mouseleave', ()=>{ els.ball.style.transform = 'rotateX(0deg) rotateY(0deg)'; });

        (function startBg(){
            const canvas = els.bg; if(!canvas) return; const ctx = canvas.getContext('2d'); if(!ctx) return;
            const DPR = Math.min(2, window.devicePixelRatio||1);
            let w=0,h=0, stars=[], meteors=[], nebulas=[]; let mx=0,my=0;
            function resize(){ const cw=window.innerWidth, ch=window.innerHeight; w=canvas.width=Math.floor(cw*DPR); h=canvas.height=Math.floor(ch*DPR); canvas.style.width=cw+'px'; canvas.style.height=ch+'px'; ctx.setTransform(DPR,0,0,DPR,0,0);
                const starCount=Math.floor((cw*ch)/9000), nebCount=Math.max(2,Math.floor((cw*ch)/420000));
                stars=new Array(starCount).fill(0).map(()=>({x:Math.random()*cw,y:Math.random()*ch,z:Math.random()*0.9+0.1,t:Math.random()*6,s:Math.random()*0.9+0.1}));
                nebulas=new Array(nebCount).fill(0).map(()=>({x:Math.random()*cw,y:Math.random()*ch,r:Math.random()*300+220,hue:Math.random()<0.5?200+Math.random()*40:120+Math.random()*30,alpha:0.08+Math.random()*0.08,drift:(Math.random()*0.6+0.2)*(Math.random()<0.5?-1:1)}));
                meteors.length=0;
            }
            resize(); window.addEventListener('resize', resize);
            window.addEventListener('mousemove', (e)=>{ const cx=window.innerWidth/2, cy=window.innerHeight/2; mx=(e.clientX-cx)/cx; my=(e.clientY-cy)/cy; });
            function neb(){ for(const n of nebulas){ n.x+=n.drift*0.05; if(n.x<-n.r) n.x=window.innerWidth+n.r; if(n.x>window.innerWidth+n.r) n.x=-n.r; const px=n.x+mx*10, py=n.y+my*6; const g=ctx.createRadialGradient(px,py,0,px,py,n.r); g.addColorStop(0,`hsla(${n.hue},70%,55%,${n.alpha})`); g.addColorStop(1,'rgba(0,0,0,0)'); ctx.fillStyle=g; ctx.beginPath(); ctx.arc(px,py,n.r,0,Math.PI*2); ctx.fill(); } }
            function galaxy(){ const cx=window.innerWidth*0.52+mx*12, cy=window.innerHeight*0.45+my*8; const coreR=Math.min(window.innerWidth,window.innerHeight)*0.10; const core=ctx.createRadialGradient(cx,cy,0,cx,cy,coreR*2.2); core.addColorStop(0,'rgba(255,255,255,0.18)'); core.addColorStop(1,'rgba(255,255,255,0)'); ctx.fillStyle=core; ctx.beginPath(); ctx.arc(cx,cy,coreR*2.2,0,Math.PI*2); ctx.fill(); const arms=4, armLen=Math.min(window.innerWidth,window.innerHeight)*0.55; ctx.globalCompositeOperation='lighter'; for(let a=0;a<arms;a++){ const base=(a/arms)*Math.PI*2; for(let i=0;i<700;i++){ const t=i/700; const ang=base+t*5.2+Math.sin(t*6)*0.05; const r=t*armLen+(Math.random()-0.5)*8; const x=cx+Math.cos(ang)*r+(Math.random()-0.5)*3; const y=cy+Math.sin(ang)*r+(Math.random()-0.5)*3; const alpha=(1-t)*0.22+Math.random()*0.06; const size=0.8+Math.random()*1.4; ctx.fillStyle=`rgba(200,220,255,${alpha.toFixed(3)})`; ctx.fillRect(x,y,size,size); } } ctx.globalCompositeOperation='source-over'; }
            function starsDraw(){ for(const s of stars){ s.x+=0.02*s.z; if(s.x>window.innerWidth) s.x=0; s.t+=0.03+0.02*s.z; const tw=0.6+0.4*Math.sin(s.t); const alpha=(0.25+0.55*s.z)*tw; const size=(0.6+1.2*s.s*s.z); const px=s.x+mx*(6*s.z), py=s.y+my*(4*s.z); ctx.fillStyle=`rgba(255,255,255,${alpha.toFixed(3)})`; ctx.fillRect(px,py,size,size);} }
            function maybeMeteor(){ if(Math.random()<0.012 && meteors.length<2){ const startX=Math.random()*window.innerWidth*0.3; const startY=-20; const speed=6+Math.random()*4; meteors.push({x:startX,y:startY,vx:speed,vy:speed*0.35,life:0,max:90+Math.random()*40}); } }
            function meteorsDraw(){ for(let i=meteors.length-1;i>=0;i--){ const m=meteors[i]; m.x+=m.vx; m.y+=m.vy; m.life++; const tail=90; const g=ctx.createLinearGradient(m.x,m.y,m.x-tail,m.y-tail*0.35); g.addColorStop(0,'rgba(255,255,255,0.9)'); g.addColorStop(1,'rgba(255,255,255,0)'); ctx.strokeStyle=g; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(m.x,m.y); ctx.lineTo(m.x-tail,m.y-tail*0.35); ctx.stroke(); if(m.life>m.max||m.x>window.innerWidth+50||m.y>window.innerHeight+50){ meteors.splice(i,1); } } }
            function tick(){ ctx.clearRect(0,0,canvas.width,canvas.height); neb(); galaxy(); starsDraw(); maybeMeteor(); meteorsDraw(); requestAnimationFrame(tick); }
            requestAnimationFrame(tick);
        })();

    })();
    </script>
</body>
</html>
